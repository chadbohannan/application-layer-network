<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALN JavaScript Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .test-suite {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ccc;
            background-color: #f9f9f9;
        }
        .test.pass {
            border-left-color: #4caf50;
            background-color: #e8f5e9;
        }
        .test.fail {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        .test.running {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-message {
            font-size: 14px;
            color: #666;
            font-family: monospace;
        }
        .summary {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .summary.pass {
            background-color: #4caf50;
            color: white;
        }
        .summary.fail {
            background-color: #f44336;
            color: white;
        }
        button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background-color: #1565c0;
        }
        .error-detail {
            background-color: #263238;
            color: #ff5252;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ALN JavaScript Unit Tests</h1>

    <div>
        <button onclick="runTests()">Run Tests</button>
    </div>

    <div id="summary"></div>
    <div id="results"></div>

    <script type="module">
        import { Packet } from '../aln/packet.js';
        import { Router } from '../aln/router.js';
        import {
            makeNetQueryPacket,
            makeNetworkRouteSharePacket,
            parseNetworkRouteSharePacket,
            makeNetworkServiceSharePacket,
            parseNetworkServiceSharePacket
        } from '../aln/utils.js';

        // Test framework
        const tests = [];
        let passCount = 0;
        let failCount = 0;

        function test(name, fn) {
            tests.push({ name, fn });
        }

        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || 'Assertion failed');
            }
        }

        function assertEqual(actual, expected, message) {
            if (actual !== expected) {
                throw new Error(message || `Expected ${expected} but got ${actual}`);
            }
        }

        function assertNotEqual(actual, expected, message) {
            if (actual === expected) {
                throw new Error(message || `Expected values to be different but both were ${actual}`);
            }
        }

        // Packet Tests
        test('Packet toJson/fromJson roundtrip', () => {
            const p = new Packet();
            p.srv = 'test-service';
            p.src = 'source-addr';
            p.dst = 'dest-addr';
            p.data = 'test data';

            const json = p.toJson();
            assert(json.includes('test-service'), 'JSON should contain service name');
        });

        test('Packet toBinary sets control flags', () => {
            const p = new Packet();
            p.srv = 'ping';
            p.src = 'client';
            p.dst = 'server';
            p.data = 'hello';

            const binary = p.toBinary();
            assert(binary.length > 0, 'Binary should have content');
            assert(p.cf > 0, 'Control flags should be set');
        });

        test('Hamming encode produces different value', () => {
            const p = new Packet();
            p.srv = 'test';
            p.toBinary();

            // After toBinary, cf should have Hamming encoding
            assert(p.cf > 0, 'Control flags should be set');
        });

        // Router Tests
        test('Router creates with address', () => {
            const router = new Router('test-router');
            assertEqual(router.address, 'test-router', 'Router address should match');
            assertEqual(router.channels.length, 0, 'Router should start with no channels');
        });

        test('Router service registration', () => {
            const router = new Router('test-router');
            let called = false;

            router.registerService('test-svc', (packet) => {
                called = true;
            });

            assert(router.serviceMap.has('test-svc'), 'Service should be registered');
        });

        test('Router context handler registration', () => {
            const router = new Router('test-router');

            const ctxID = router.registerContextHandler((packet) => {});

            assert(ctxID > 0, 'Context ID should be positive');
            assert(router.contextMap[ctxID] !== undefined, 'Context handler should be registered');
        });

        // Utility Tests
        test('makeNetQueryPacket creates correct packet', () => {
            const p = makeNetQueryPacket();
            assertEqual(p.net, 3, 'NET_QUERY should be 3');
        });

        test('Route packet roundtrip', () => {
            const p = makeNetworkRouteSharePacket('source', 'destination', 5);
            assertEqual(p.net, 1, 'NET_ROUTE should be 1');
            assertEqual(p.src, 'source', 'Source should match');

            const [dest, nextHop, cost, err] = parseNetworkRouteSharePacket(p);
            assertEqual(err, null, 'Should parse without error');
            assertEqual(dest, 'destination', 'Destination should match');
            assertEqual(nextHop, 'source', 'Next hop should be source');
            assertEqual(cost, 5, 'Cost should match');
        });

        test('Service packet roundtrip', () => {
            const p = makeNetworkServiceSharePacket('host-addr', 'my-service', 10);
            assertEqual(p.net, 2, 'NET_SERVICE should be 2');

            const [addr, serviceID, capacity, err] = parseNetworkServiceSharePacket(p);
            assertEqual(err, null, 'Should parse without error');
            assertEqual(addr, 'host-addr', 'Address should match');
            assertEqual(serviceID, 'my-service', 'Service ID should match');
            assertEqual(capacity, 10, 'Capacity should match');
        });

        test('Router route learning', () => {
            const router = new Router('router1');

            // Simulate receiving a route advertisement
            const routePacket = makeNetworkRouteSharePacket('router2', 'router3', 2);

            // Create a mock channel
            const mockChannel = {
                send: (p) => {},
                onPacket: null,
                onClose: null
            };

            router.onPacket(routePacket, mockChannel);

            // Check if route was learned
            assert(router.remoteNodeMap.has('router3'), 'Route should be learned');
            const route = router.remoteNodeMap.get('router3');
            assertEqual(route.cost, 2, 'Cost should match');
        });

        test('Router service discovery', () => {
            const router = new Router('router1');

            // Register local service
            router.registerService('ping', (p) => {});

            // Service should be findable
            const addr = router.selectService('ping');
            assertEqual(addr, 'router1', 'Should find local service');
        });

        test('Router service selection with capacity', () => {
            const router = new Router('router1');

            // Simulate receiving service advertisements
            const svcPacket1 = makeNetworkServiceSharePacket('server1', 'api', 5);
            const svcPacket2 = makeNetworkServiceSharePacket('server2', 'api', 10);

            const mockChannel = {
                send: (p) => {},
                onPacket: null,
                onClose: null
            };

            router.onPacket(svcPacket1, mockChannel);
            router.onPacket(svcPacket2, mockChannel);

            // Should select server with higher capacity
            const addr = router.selectService('api');
            assertEqual(addr, 'server2', 'Should select server with higher capacity');
        });

        // Run all tests
        window.runTests = async function() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            resultsDiv.innerHTML = '';
            summaryDiv.innerHTML = '';
            passCount = 0;
            failCount = 0;

            for (const { name, fn } of tests) {
                const testDiv = document.createElement('div');
                testDiv.className = 'test running';
                testDiv.innerHTML = `
                    <div class="test-name">${name}</div>
                    <div class="test-message">Running...</div>
                `;
                resultsDiv.appendChild(testDiv);

                try {
                    await fn();
                    testDiv.className = 'test pass';
                    testDiv.querySelector('.test-message').textContent = 'PASS';
                    passCount++;
                } catch (error) {
                    testDiv.className = 'test fail';
                    testDiv.querySelector('.test-message').textContent = 'FAIL: ' + error.message;
                    testDiv.innerHTML += `<div class="error-detail">${error.stack}</div>`;
                    failCount++;
                }
            }

            // Show summary
            const total = tests.length;
            const summaryClass = failCount === 0 ? 'pass' : 'fail';
            summaryDiv.innerHTML = `
                <div class="summary ${summaryClass}">
                    Tests: ${passCount}/${total} passed, ${failCount} failed
                </div>
            `;
        };

        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, ready to run tests');
        });
    </script>
</body>
</html>
